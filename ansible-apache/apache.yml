---
- hosts: vagrant
  become: true
  vars:
    http_port: 80
    domain: www.leodis.ac.uk
    domain_alias: leodis.ac.uk leodis.co.uk www.leodis.co.uk leodis.net www.leodis.net
    proxy_port: 1337
  tasks:
    - name: install apache2
      apt: name=apache2=2.2.22-1ubuntu1.10 update_cache=yes state=present

    - name: Set Apache FQDN
      copy: content="ServerName localhost" dest=/etc/apache2/conf.d/fqdn
      notify:
        - restart apache2

    - name: a2dissite 000-default
      command: a2dissite 000-default
      args:
        removes: /etc/apache2/sites-enabled/000-default
      notify:
          - restart apache2

    # Enabling Apache Modules - matched from ec2 instance

    - name: enabled asis
      apache2_module: name=asis state=present
      notify:
        - restart apache2

    - name: enabled authn_default
      apache2_module: name=authn_default state=present
      notify:
        - restart apache2

    - name: enabled cache
      apache2_module: name=cache state=present
      notify:
        - restart apache2

    - name: enabled dav
      apache2_module: name=dav state=present
      notify:
        - restart apache2

    - name: enabled disk_cache
      apache2_module: name=disk_cache state=present
      notify:
        - restart apache2

    - name: enabled dav_fs
      apache2_module: name=dav_fs state=present
      notify:
        - restart apache2

    - name: enabled dav_lock
      apache2_module: name=dav_lock state=present
      notify:
        - restart apache2

    - name: enabled expires
      apache2_module: name=expires state=present
      notify:
        - restart apache2

    - name: enabled filter
      apache2_module: name=filter state=present
      notify:
        - restart apache2

    - name: enabled headers
      apache2_module: name=headers state=present
      notify:
        - restart apache2

    - name: enabled include
      apache2_module: name=include state=present
      notify:
        - restart apache2

    - name: enabled proxy
      apache2_module: name=proxy state=present
      notify:
        - restart apache2

    - name: enabled proxy_connect
      apache2_module: name=proxy_connect state=present
      notify:
        - restart apache2

    - name: enabled proxy_http
      apache2_module: name=proxy_http state=present
      notify:
        - restart apache2

    - name: enabled rewrite
      apache2_module: name=rewrite state=present
      notify:
        - restart apache2

    - name: enabled vhost_alias
      apache2_module: name=vhost_alias state=present
      notify:
        - restart apache2

    # Enable website

    - name: create leodis virtual host file
      template: src=virtualhost-proxy.conf dest=/etc/apache2/sites-available/{{ domain }}.conf

    - name: a2ensite {{ domain }}
      command: a2ensite {{ domain }}.conf
      args:
        creates: /etc/apache2/sites-enabled/{{ domain }}.conf
      notify:
        - restart apache2

  handlers:
    - name: restart apache2
      service: name=apache2 state=restarted
